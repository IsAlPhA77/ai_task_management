<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Task Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Calendar Specifics */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-cell {
            min-height: 100px;
        }
    </style>
</head>
<body>
<div id="app" class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Auth Screen (Login / Register) -->
    <div v-if="!auth.isLoggedIn" class="flex-1 flex items-center justify-center bg-slate-50">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-100 transition-all duration-300">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-indigo-600 text-white mb-4">
                    <i class="fa-solid fa-brain text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">AI Task Manager</h1>
                <p class="text-slate-500 mt-2 text-sm">
                    {{ isRegistering ? 'Create your account' : 'Intelligent productivity powered by Data' }}</p>
            </div>

            <!-- CORS Warning (Visible if API fails) -->
            <div v-if="connectionError"
                 class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
                <div class="font-bold flex items-center gap-2 mb-1">
                    <i class="fa-solid fa-triangle-exclamation"></i> Connection Failed (CORS)
                </div>
                <p class="mb-2">Your browser blocked the request to <code>localhost:8080</code>.</p>
                <p>To fix this, add this to your Backend Controller:</p>
                <code class="block bg-amber-100 p-2 rounded mt-1 text-xs font-mono">@CrossOrigin(origins =
                    "http://127.0.0.1:8000", allowCredentials = "true")</code>
                <button @click="isDemoMode = true; connectionError = false"
                        class="mt-3 text-indigo-600 hover:underline font-medium">
                    Switch to Demo Mode for now &rarr;
                </button>
            </div>

            <!-- Login Form -->
            <form v-if="!isRegistering" @submit.prevent="handleLogin" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Account</label>
                    <input v-model="loginForm.account" type="text"
                           class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
                           placeholder="Enter account name" required>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Password</label>
                    <input v-model="loginForm.password" type="password"
                           class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
                           placeholder="••••••••" required>
                </div>

                <button :disabled="loading" type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i v-if="loading" class="fa-solid fa-circle-notch fa-spin"></i>
                    <span v-else>Sign In</span>
                </button>
            </form>

            <!-- Register Form -->
            <form v-else @submit.prevent="handleRegister" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Account</label>
                        <input v-model="registerForm.account" type="text"
                               class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:border-indigo-500 outline-none"
                               placeholder="Username" required>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Nickname</label>
                        <input v-model="registerForm.nickname" type="text"
                               class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:border-indigo-500 outline-none"
                               placeholder="Display Name">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Email</label>
                    <input v-model="registerForm.email" type="email"
                           class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:border-indigo-500 outline-none"
                           placeholder="you@example.com" required>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Password</label>
                    <input v-model="registerForm.password" type="password"
                           class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:border-indigo-500 outline-none"
                           placeholder="Min 6 chars" required>
                </div>

                <button :disabled="loading" type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i v-if="loading" class="fa-solid fa-circle-notch fa-spin"></i>
                    <span v-else>Create Account</span>
                </button>
            </form>

            <div class="mt-6 flex flex-col items-center gap-4 text-sm">
                <button @click="isRegistering = !isRegistering"
                        class="text-indigo-600 hover:text-indigo-800 font-medium">
                    {{ isRegistering ? 'Already have an account? Sign In' : 'New here? Create an account' }}
                </button>

                <div class="flex items-center gap-2 w-full justify-center pt-4 border-t border-slate-100">
                    <input type="checkbox" v-model="isDemoMode" id="demoMode"
                           class="rounded text-indigo-600 focus:ring-indigo-500">
                    <label for="demoMode" class="text-slate-600 cursor-pointer select-none">Demo Mode (No
                        Backend)</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Layout -->
    <div v-else class="flex h-screen bg-slate-50">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-10 hidden md:flex">
            <div class="p-6 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center">
                    <i class="fa-solid fa-brain text-sm"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">AI Tasks</span>
            </div>

            <nav class="flex-1 px-4 space-y-1 mt-4">
                <button @click="currentView = 'dashboard'" :class="navClass('dashboard')"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
                </button>
                <button @click="currentView = 'calendar'" :class="navClass('calendar')"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-regular fa-calendar-days w-5"></i> Calendar
                </button>
                <button @click="currentView = 'tasks'" :class="navClass('tasks')"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-list-check w-5"></i> All Tasks
                </button>
                <button @click="currentView = 'ai'" :class="navClass('ai')"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-wand-magic-sparkles w-5"></i> AI Assistant
                </button>
                <button @click="currentView = 'reports'" :class="navClass('reports')"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-file-lines w-5"></i> Reports
                </button>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <div class="flex items-center gap-3 px-2 py-2">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">
                        {{ userInitials }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-900 truncate">{{ auth.user?.nickname || 'User' }}</p>
                        <p class="text-xs text-slate-500 truncate">{{ auth.user?.email || 'user@example.com' }}</p>
                    </div>
                    <button @click="logout" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="md:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between">
                <span class="font-bold text-lg">AI Tasks</span>
                <button class="text-slate-600"><i class="fa-solid fa-bars"></i></button>
            </header>

            <!-- Views -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8">

                <!-- DASHBOARD VIEW -->
                <div v-if="currentView === 'dashboard'" class="max-w-5xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-slate-800">Overview</h2>
                        <div class="text-sm text-slate-500">{{ todayDate }}</div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-slate-400 text-xs font-semibold uppercase mb-1">Todo</div>
                            <div class="text-2xl font-bold text-slate-800">{{ stats.todoTasks }}</div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-slate-400 text-xs font-semibold uppercase mb-1">In Progress</div>
                            <div class="text-2xl font-bold text-blue-600">{{ stats.inProgressTasks }}</div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-slate-400 text-xs font-semibold uppercase mb-1">Overdue</div>
                            <div class="text-2xl font-bold text-red-500">{{ stats.overdueTasks }}</div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-slate-400 text-xs font-semibold uppercase mb-1">Completion</div>
                            <div class="text-2xl font-bold text-green-600">{{ stats.completionRate }}%</div>
                        </div>
                    </div>

                    <!-- Quick AI Action -->
                    <div class="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-8 opacity-10 transform translate-x-10 -translate-y-10">
                            <i class="fa-solid fa-robot text-9xl"></i>
                        </div>
                        <div class="relative z-10">
                            <h3 class="text-xl font-bold mb-2">Create with AI</h3>
                            <p class="text-indigo-100 mb-4 text-sm max-w-lg">Describe your task naturally. Our AI will
                                extract the deadline, priority, and categorization automatically.</p>
                            <div class="flex gap-2">
                                <input v-model="quickAiInput" @keyup.enter="createTaskAI" type="text"
                                       placeholder="e.g. Prepare weekly report by Friday 5pm priority high"
                                       class="flex-1 px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-indigo-200 focus:outline-none focus:bg-white/30 backdrop-blur-sm transition-all">
                                <button @click="createTaskAI"
                                        class="bg-white text-indigo-600 px-6 py-3 rounded-xl font-semibold hover:bg-indigo-50 transition-colors">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Tasks -->
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">Priority Tasks</h3>
                            <button @click="currentView = 'tasks'"
                                    class="text-xs text-indigo-600 font-medium hover:underline">View All
                            </button>
                        </div>
                        <div v-if="tasks.length === 0" class="p-8 text-center text-slate-400">
                            No tasks found. Start by creating one!
                        </div>
                        <div v-else class="divide-y divide-slate-100">
                            <div v-for="task in priorityTasks" :key="task.id"
                                 class="p-4 hover:bg-slate-50 transition-colors flex items-center gap-4">
                                <div :class="statusColor(task.status)" class="w-2 h-2 rounded-full shrink-0"></div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-sm font-medium text-slate-900 truncate">{{ task.title }}</h4>
                                    <p class="text-xs text-slate-500 truncate">{{ task.description || 'No description'
                                        }}</p>
                                </div>
                                <div class="flex items-center gap-4 text-xs text-slate-500">
                                        <span v-if="task.deadline"
                                              :class="{'text-red-500 font-bold': isOverdue(task.deadline)}">
                                            <i class="fa-regular fa-clock mr-1"></i>{{ formatDate(task.deadline) }}
                                        </span>
                                    <span class="px-2 py-1 rounded bg-slate-100 font-medium text-slate-600">
                                            Priority {{ task.priority }}
                                        </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CALENDAR VIEW -->
                <div v-if="currentView === 'calendar'" class="h-full flex flex-col max-w-6xl mx-auto">
                    <!-- Calendar Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Calendar</h2>

                        <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-200">
                            <button @click="calendarMode = 'month'"
                                    :class="calendarMode === 'month' ? 'bg-indigo-100 text-indigo-700 font-medium' : 'text-slate-600 hover:bg-slate-50'"
                                    class="px-3 py-1.5 rounded-md text-sm transition-colors">Month
                            </button>
                            <button @click="calendarMode = 'week'"
                                    :class="calendarMode === 'week' ? 'bg-indigo-100 text-indigo-700 font-medium' : 'text-slate-600 hover:bg-slate-50'"
                                    class="px-3 py-1.5 rounded-md text-sm transition-colors">Week
                            </button>
                            <button @click="calendarMode = 'day'"
                                    :class="calendarMode === 'day' ? 'bg-indigo-100 text-indigo-700 font-medium' : 'text-slate-600 hover:bg-slate-50'"
                                    class="px-3 py-1.5 rounded-md text-sm transition-colors">Day
                            </button>
                        </div>

                        <div class="flex items-center gap-3">
                            <button @click="changeCalendarPeriod(-1)"
                                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-500">
                                <i class="fa-solid fa-chevron-left"></i></button>
                            <span class="font-semibold text-slate-700 w-32 text-center">{{ calendarTitle }}</span>
                            <button @click="changeCalendarPeriod(1)"
                                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-500">
                                <i class="fa-solid fa-chevron-right"></i></button>
                            <button @click="resetCalendarToToday" class="text-sm text-indigo-600 font-medium ml-2">
                                Today
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Body -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex-1 overflow-hidden flex flex-col">

                        <!-- Month View Grid -->
                        <div v-if="calendarMode === 'month'" class="flex-1 flex flex-col">
                            <!-- Weekday Headers -->
                            <div class="grid grid-cols-7 border-b border-slate-200 bg-slate-50">
                                <div v-for="day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']"
                                     class="py-2 text-center text-xs font-semibold text-slate-500 uppercase">
                                    {{ day }}
                                </div>
                            </div>
                            <!-- Days -->
                            <div class="grid grid-cols-7 flex-1 auto-rows-fr">
                                <div v-for="(day, index) in calendarDays" :key="index"
                                     class="min-h-[100px] border-b border-r border-slate-100 p-2 relative group hover:bg-slate-50 transition-colors"
                                     :class="{'bg-slate-50/50 text-slate-400': !day.isCurrentMonth, 'bg-indigo-50/30': day.isToday}">

                                    <div class="text-xs font-medium mb-1 flex justify-between">
                                            <span :class="{'w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center': day.isToday}">
                                                {{ day.date.getDate() }}
                                            </span>
                                        <button v-if="day.isCurrentMonth" @click="openCreateModal(day.dateString)"
                                                class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-indigo-600">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>

                                    <div class="space-y-1 overflow-y-auto max-h-[80px]">
                                        <div v-for="task in getTasksForDate(day.dateString)" :key="task.id"
                                             @click="editTask(task)"
                                             class="text-[10px] px-1.5 py-0.5 rounded border truncate cursor-pointer hover:opacity-80 transition-opacity"
                                             :class="taskStyle(task)">
                                            {{ task.title }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Week View -->
                        <div v-if="calendarMode === 'week'" class="flex-1 flex flex-col overflow-auto">
                            <div class="grid grid-cols-7 min-w-[800px] flex-1">
                                <div v-for="day in weekDays" :key="day.dateString"
                                     class="border-r border-slate-200 flex flex-col min-h-[400px]">
                                    <div class="p-3 border-b border-slate-200 bg-slate-50 text-center sticky top-0 z-10">
                                        <div class="text-xs text-slate-500 uppercase mb-1">{{ day.dayName }}</div>
                                        <div class="font-bold text-lg" :class="{'text-indigo-600': day.isToday}">
                                            {{ day.dayNum }}
                                        </div>
                                    </div>
                                    <div class="flex-1 p-2 space-y-2 bg-white">
                                        <div v-for="task in getTasksForDate(day.dateString)" :key="task.id"
                                             @click="editTask(task)"
                                             class="p-2 rounded border text-xs shadow-sm cursor-pointer hover:shadow-md transition-all"
                                             :class="taskStyle(task, true)">
                                            <div class="font-medium truncate mb-1">{{ task.title }}</div>
                                            <div class="flex justify-between text-[10px] opacity-75">
                                                <span>{{ formatTime(task.deadline) }}</span>
                                                <span>P{{ task.priority }}</span>
                                            </div>
                                        </div>
                                        <button @click="openCreateModal(day.dateString)"
                                                class="w-full py-2 text-xs text-slate-400 border border-dashed border-slate-300 rounded hover:border-indigo-400 hover:text-indigo-500 transition-colors">
                                            <i class="fa-solid fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Day View -->
                        <div v-if="calendarMode === 'day'" class="flex-1 p-6 overflow-auto">
                            <div class="max-w-3xl mx-auto">
                                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                                    <h3 class="text-xl font-bold">{{ calendarTitle }}</h3>
                                    <button @click="openCreateModal(formatDateInput(currentCalendarDate))"
                                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">
                                        Add Task Today
                                    </button>
                                </div>

                                <div class="space-y-3">
                                    <div v-for="task in getTasksForDate(formatDateInput(currentCalendarDate))"
                                         :key="task.id"
                                         class="flex items-center gap-4 p-4 rounded-xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition-all">
                                        <div class="flex flex-col items-center justify-center w-14 h-14 rounded-lg bg-slate-50 border border-slate-100">
                                            <span class="text-xs text-slate-500 font-bold">{{ formatTime(task.deadline) || 'All'
                                                }}</span>
                                            <span class="text-[10px] text-slate-400 uppercase">Day</span>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-800">{{ task.title }}</h4>
                                            <p class="text-sm text-slate-500 line-clamp-1">{{ task.description }}</p>
                                        </div>
                                        <div class="text-right">
                                            <span :class="statusBadgeClass(task.status)"
                                                  class="px-2 py-1 rounded text-xs font-bold uppercase">{{ task.status
                                                }}</span>
                                        </div>
                                        <button @click="editTask(task)" class="text-slate-400 hover:text-indigo-600">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                    </div>
                                    <div v-if="getTasksForDate(formatDateInput(currentCalendarDate)).length === 0"
                                         class="text-center py-12 text-slate-400">
                                        <i class="fa-regular fa-calendar-check text-4xl mb-3"></i>
                                        <p>No tasks scheduled for this day.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TASKS LIST VIEW -->
                <div v-if="currentView === 'tasks'" class="max-w-6xl mx-auto h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">My Tasks</h2>
                        <button @click="showCreateModal = true"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fa-solid fa-plus mr-2"></i>New Task
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-xl border border-slate-200 mb-6 flex gap-4 flex-wrap">
                        <div class="relative flex-1 min-w-[200px]">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                            <input v-model="filters.search" type="text" placeholder="Search tasks..."
                                   class="w-full pl-9 pr-4 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm focus:outline-none focus:border-indigo-500">
                        </div>
                        <select v-model="filters.status"
                                class="px-4 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm text-slate-600 focus:outline-none">
                            <option value="">All Status</option>
                            <option value="TODO">To Do</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                        </select>
                        <button @click="fetchTasks" class="p-2 text-slate-500 hover:text-indigo-600 transition-colors">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                    </div>

                    <!-- Task Grid -->
                    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 pb-20">
                        <div v-for="task in filteredTasks" :key="task.id"
                             class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow group relative">
                            <div class="flex justify-between items-start mb-3">
                                    <span :class="statusBadgeClass(task.status)"
                                          class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide">
                                        {{ task.status.replace('_', ' ') }}
                                    </span>
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                    <button @click="deleteTask(task.id)" class="text-slate-400 hover:text-red-500"><i
                                            class="fa-solid fa-trash"></i></button>
                                    <button @click="editTask(task)" class="text-slate-400 hover:text-indigo-600"><i
                                            class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-slate-800 mb-2 line-clamp-1">{{ task.title }}</h3>
                            <p class="text-sm text-slate-500 mb-4 line-clamp-2 h-10">
                                {{ task.description || 'No description provided.' }}</p>

                            <div class="flex items-center justify-between text-xs text-slate-500 pt-4 border-t border-slate-100">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-flag text-indigo-400"></i> {{ task.priority }}
                                </div>
                                <div class="flex items-center gap-1">
                                    <i class="fa-regular fa-clock"></i> {{ task.estimatedDuration }}m
                                </div>
                                <div v-if="task.deadline"
                                     :class="isOverdue(task.deadline) ? 'text-red-500 font-bold' : ''">
                                    {{ formatDate(task.deadline) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI HUB VIEW -->
                <div v-if="currentView === 'ai'" class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">AI Hub</h2>
                    <p class="text-slate-500 mb-8">Utilize advanced algorithms to optimize your workflow.</p>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Natural Language Input -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center mb-4">
                                <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-2">Smart Creation</h3>
                            <p class="text-sm text-slate-500 mb-4">Paste emails, chat logs, or rough notes. AI will
                                structure them into tasks.</p>
                            <textarea v-model="naturalLanguageInput"
                                      class="w-full h-32 p-4 rounded-xl bg-slate-50 border border-slate-200 text-sm mb-4 focus:border-purple-500 focus:ring-1 focus:ring-purple-200 outline-none resize-none"
                                      placeholder="E.g. I need to finish the marketing deck by Friday and schedule a review with the team on Monday morning..."></textarea>
                            <button @click="processNaturalLanguage" :disabled="loading"
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium transition-colors">
                                <span v-if="loading"><i class="fa-solid fa-spinner fa-spin"></i> Processing...</span>
                                <span v-else>Parse & Create</span>
                            </button>
                        </div>

                        <!-- Recommendations -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="w-12 h-12 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center mb-4">
                                <i class="fa-solid fa-arrow-up-right-dots text-xl"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-2">Priority Optimization</h3>
                            <p class="text-sm text-slate-500 mb-4">Analyze deadlines and dependencies to recommend
                                optimal task ordering.</p>

                            <div v-if="recommendations.length > 0" class="space-y-3 mb-4 max-h-48 overflow-y-auto">
                                <div v-for="rec in recommendations" :key="rec.taskId"
                                     class="text-sm p-3 bg-amber-50 rounded-lg border border-amber-100">
                                    <div class="font-medium text-slate-800">{{ rec.taskTitle }}</div>
                                    <div class="flex justify-between mt-1 text-xs">
                                        <span class="text-slate-500">Current: {{ rec.currentPriority }}</span>
                                        <span class="text-amber-600 font-bold">Rec: {{ rec.recommendedPriority }}</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else
                                 class="h-32 flex items-center justify-center text-slate-400 text-sm italic bg-slate-50 rounded-lg mb-4">
                                No recommendations yet
                            </div>

                            <button @click="getPriorityRecommendations" :disabled="loading"
                                    class="w-full bg-amber-500 hover:bg-amber-600 text-white py-2 rounded-lg font-medium transition-colors">
                                Analyze Priorities
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <transition name="fade">
        <div v-if="toast.show" :class="toast.type === 'error' ? 'bg-red-500' : 'bg-green-600'"
             class="fixed bottom-6 right-6 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 z-50">
            <i :class="toast.type === 'error' ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-circle-check'"></i>
            <span class="text-sm font-medium">{{ toast.message }}</span>
        </div>
    </transition>

    <!-- New Task Modal (Reusable) -->
    <div v-if="showCreateModal"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">New Task</h3>
                <button @click="showCreateModal = false" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <form @submit.prevent="createTaskManual" class="space-y-4">
                <input v-model="newTask.title" type="text" placeholder="Task Title"
                       class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 outline-none"
                       required>
                <textarea v-model="newTask.description" placeholder="Description"
                          class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 outline-none h-24 resize-none"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input v-model="newTask.deadline" type="datetime-local"
                           class="w-full px-4 py-2 rounded-lg border border-slate-200 outline-none text-slate-600">
                    <input v-model.number="newTask.priority" type="number" placeholder="Priority (0-100)"
                           class="w-full px-4 py-2 rounded-lg border border-slate-200 outline-none">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" @click="showCreateModal = false"
                            class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium">Cancel
                    </button>
                    <button type="submit"
                            class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium">Create
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
    const {createApp, ref, reactive, computed, onMounted} = Vue;

    createApp({
        setup() {
            // --- State ---
            const isDemoMode = ref(true); // Default to true if connection fails initially
            const connectionError = ref(false); // Tracks CORS/Network errors
            const loading = ref(false);
            const currentView = ref('dashboard');
            const showCreateModal = ref(false);
            const isRegistering = ref(false);

            // Safe LocalStorage Wrapper (Fixes "Tracking Prevention blocked access")
            const safeStorage = {
                getItem: (key) => {
                    try {
                        return localStorage.getItem(key);
                    } catch (e) {
                        return null;
                    }
                },
                setItem: (key, value) => {
                    try {
                        localStorage.setItem(key, value);
                    } catch (e) {
                        console.warn("Storage blocked");
                    }
                },
                removeItem: (key) => {
                    try {
                        localStorage.removeItem(key);
                    } catch (e) {
                    }
                }
            };

            const auth = reactive({
                isLoggedIn: false,
                user: null,
                token: safeStorage.getItem('auth_token') || null
            });

            // Check for existing session on load
            if (auth.token) {
                auth.isLoggedIn = true;
                // Ideally you would validate the token with an API call here
            }

            const loginForm = reactive({account: '', password: ''});
            const registerForm = reactive({account: '', nickname: '', email: '', password: ''});

            const tasks = ref([]);
            const stats = reactive({
                todoTasks: 0,
                inProgressTasks: 0,
                overdueTasks: 0,
                completionRate: 0
            });
            const filters = reactive({search: '', status: ''});
            const quickAiInput = ref('');
            const naturalLanguageInput = ref('');
            const recommendations = ref([]);
            const newTask = reactive({title: '', description: '', deadline: '', priority: 50});
            const toast = reactive({show: false, message: '', type: 'success'});

            // --- Calendar State ---
            const calendarMode = ref('month');
            const currentCalendarDate = ref(new Date());

            // --- Configuration ---
            const API_BASE = 'http://localhost:8080/api';

            // --- Helpers ---
            const showToast = (msg, type = 'success') => {
                toast.message = msg;
                toast.type = type;
                toast.show = true;
                setTimeout(() => toast.show = false, 3000);
            };

            const userInitials = computed(() => {
                if (!auth.user || !auth.user.nickname) return 'U';
                return auth.user.nickname.substring(0, 2).toUpperCase();
            });

            const filteredTasks = computed(() => {
                return tasks.value.filter(t => {
                    const matchSearch = t.title.toLowerCase().includes(filters.search.toLowerCase());
                    const matchStatus = filters.status ? t.status === filters.status : true;
                    return matchSearch && matchStatus;
                });
            });

            const priorityTasks = computed(() => {
                return [...tasks.value].sort((a, b) => b.priority - a.priority).slice(0, 5);
            });

            // --- Calendar Logic ---
            // ... (Same as before)
            const calendarTitle = computed(() => {
                const d = currentCalendarDate.value;
                if (calendarMode.value === 'month') {
                    return d.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});
                } else if (calendarMode.value === 'week') {
                    const start = getStartOfWeek(d);
                    const end = new Date(start);
                    end.setDate(end.getDate() + 6);
                    return `${start.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    })} - ${end.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}`;
                } else {
                    return d.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'});
                }
            });

            const calendarDays = computed(() => {
                if (calendarMode.value !== 'month') return [];
                const year = currentCalendarDate.value.getFullYear();
                const month = currentCalendarDate.value.getMonth();

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                const days = [];
                const startDay = firstDayOfMonth.getDay();
                for (let i = startDay; i > 0; i--) {
                    const d = new Date(year, month, 1 - i);
                    days.push({date: d, isCurrentMonth: false, dateString: formatDateInput(d)});
                }
                for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                    const d = new Date(year, month, i);
                    days.push({
                        date: d,
                        isCurrentMonth: true,
                        isToday: isSameDay(d, new Date()),
                        dateString: formatDateInput(d)
                    });
                }
                const remainingCells = 42 - days.length;
                for (let i = 1; i <= remainingCells; i++) {
                    const d = new Date(year, month + 1, i);
                    days.push({date: d, isCurrentMonth: false, dateString: formatDateInput(d)});
                }
                return days;
            });

            const weekDays = computed(() => {
                if (calendarMode.value !== 'week') return [];
                const start = getStartOfWeek(currentCalendarDate.value);
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    days.push({
                        date: d,
                        dayName: d.toLocaleDateString('en-US', {weekday: 'short'}),
                        dayNum: d.getDate(),
                        isToday: isSameDay(d, new Date()),
                        dateString: formatDateInput(d)
                    });
                }
                return days;
            });

            const getStartOfWeek = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day;
                return new Date(d.setDate(diff));
            };

            const isSameDay = (d1, d2) => {
                return d1.getDate() === d2.getDate() &&
                    d1.getMonth() === d2.getMonth() &&
                    d1.getFullYear() === d2.getFullYear();
            };

            const changeCalendarPeriod = (delta) => {
                const d = new Date(currentCalendarDate.value);
                if (calendarMode.value === 'month') {
                    d.setMonth(d.getMonth() + delta);
                } else if (calendarMode.value === 'week') {
                    d.setDate(d.getDate() + (delta * 7));
                } else {
                    d.setDate(d.getDate() + delta);
                }
                currentCalendarDate.value = d;
            };

            const resetCalendarToToday = () => {
                currentCalendarDate.value = new Date();
            };

            const getTasksForDate = (dateStr) => {
                return tasks.value.filter(t => {
                    if (!t.deadline) return false;
                    return t.deadline.startsWith(dateStr);
                });
            };

            const taskStyle = (task, isFull = false) => {
                let base = isFull ? 'border-l-4 ' : 'border-l-2 ';
                switch (task.status) {
                    case 'TODO':
                        return base + 'border-slate-400 bg-slate-50 text-slate-600';
                    case 'IN_PROGRESS':
                        return base + 'border-blue-500 bg-blue-50 text-blue-700';
                    case 'COMPLETED':
                        return base + 'border-green-500 bg-green-50 text-green-700 line-through opacity-75';
                    case 'OVERDUE':
                        return base + 'border-red-500 bg-red-50 text-red-700';
                    default:
                        return base + 'border-slate-400';
                }
            };

            const openCreateModal = (dateStr) => {
                newTask.title = '';
                newTask.description = '';
                newTask.priority = 50;
                newTask.deadline = `${dateStr}T09:00`;
                showCreateModal.value = true;
            };

            const formatTime = (isoString) => {
                if (!isoString) return '';
                const d = new Date(isoString);
                return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            };

            const formatDateInput = (date) => {
                const offset = date.getTimezoneOffset();
                const d = new Date(date.getTime() - (offset * 60 * 1000));
                return d.toISOString().split('T')[0];
            };


            // --- API Interactions (Mock & Real) ---

            const apiCall = async (endpoint, method = 'GET', body = null, isAuth = true) => {
                if (isDemoMode.value) return mockApi(endpoint, method, body);

                try {
                    const headers = {'Content-Type': 'application/json'};

                    // 1. Add Authorization Header from State or Safe Storage
                    const token = auth.token || safeStorage.getItem('auth_token');
                    if (isAuth && token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    let url = `${API_BASE}${endpoint}`;
                    if (auth.user && isAuth) {
                        const separator = url.includes('?') ? '&' : '?';
                        url += `${separator}userId=${auth.user.id}`;
                    }

                    const res = await fetch(url, {
                        method,
                        headers,
                        // 2. Include Credentials for Refresh Token Cookie
                        credentials: 'include',
                        body: body ? JSON.stringify(body) : null
                    });

                    const json = await res.json();
                    if (res.ok) {
                        connectionError.value = false;
                        return json.data;
                    }
                    throw new Error(json.message || 'API Error');
                } catch (e) {
                    console.error("API Error", e);
                    // Detect CORS/Network failure vs Logical API failure
                    if (e.message.includes('Failed to fetch') || e.name === 'TypeError') {
                        connectionError.value = true;
                    }
                    throw e;
                }
            };

            // --- Mock Data Generator ---
            const mockApi = (endpoint, method, body) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (endpoint.includes('/user/login')) {
                            resolve({
                                user: {id: 1, account: 'admin', nickname: 'Demo User', email: 'demo@example.com'},
                                accessToken: 'mock-token-123'
                            });
                        } else if (endpoint.includes('/user/register')) {
                            resolve({
                                user: {id: 2, account: body.account, nickname: body.nickname, email: body.email},
                                accessToken: 'mock-token-new-user'
                            });
                        } else if (endpoint.includes('/tasks/statistics')) {
                            resolve({
                                todoTasks: 12,
                                inProgressTasks: 5,
                                overdueTasks: 2,
                                completionRate: 68
                            });
                        } else if (endpoint.includes('/tasks/natural-language')) {
                            resolve([{
                                id: Date.now(),
                                title: "AI Generated: " + body.naturalLanguage.substring(0, 20) + "...",
                                status: 'TODO',
                                priority: 85,
                                deadline: new Date(Date.now() + 86400000).toISOString(),
                                description: "Parsed from input",
                                estimatedDuration: 60
                            }]);
                        } else if (endpoint.includes('/task-priority/recommendations')) {
                            resolve([
                                {
                                    taskId: 101,
                                    taskTitle: "Review Q3 Report",
                                    currentPriority: 30,
                                    recommendedPriority: 90
                                },
                                {
                                    taskId: 102,
                                    taskTitle: "Update Dependencies",
                                    currentPriority: 50,
                                    recommendedPriority: 45
                                }
                            ]);
                        } else if (method === 'GET' && endpoint.includes('/tasks')) {
                            const today = new Date();
                            const tomorrow = new Date(today);
                            tomorrow.setDate(today.getDate() + 1);

                            resolve([
                                {
                                    id: 1,
                                    title: "Prepare Weekly Report",
                                    status: 'TODO',
                                    priority: 80,
                                    deadline: today.toISOString(),
                                    estimatedDuration: 45
                                },
                                {
                                    id: 2,
                                    title: "Fix Login Bug",
                                    status: 'IN_PROGRESS',
                                    priority: 95,
                                    deadline: tomorrow.toISOString(),
                                    estimatedDuration: 120
                                },
                                {
                                    id: 3,
                                    title: "Update Documentation",
                                    status: 'COMPLETED',
                                    priority: 20,
                                    deadline: null,
                                    estimatedDuration: 30
                                },
                                {
                                    id: 4,
                                    title: "Team Sync",
                                    status: 'TODO',
                                    priority: 60,
                                    deadline: new Date(today.getTime() + 86400000 * 5).toISOString(),
                                    estimatedDuration: 60
                                },
                            ]);
                        } else {
                            resolve({});
                        }
                    }, 600);
                });
            };

            // --- Actions ---

            const handleLogin = async () => {
                loading.value = true;
                connectionError.value = false;
                // Reset demo mode to try real connection
                if (isDemoMode.value && !connectionError.value) {
                    // Optional: You might want to force attempt real API here
                    // isDemoMode.value = false;
                }

                try {
                    const data = await apiCall('/user/login', 'POST', loginForm, false);

                    // 3. Store Token Safely
                    auth.user = data.user;
                    auth.token = data.accessToken;
                    safeStorage.setItem('auth_token', data.accessToken);
                    // Store user info if needed
                    // safeStorage.setItem('user_info', JSON.stringify(data.user));

                    auth.isLoggedIn = true;
                    showToast('Welcome back!');
                    await refreshData();
                } catch (e) {
                    if (connectionError.value) {
                        showToast('Connection failed (CORS/Network)', 'error');
                    } else {
                        showToast('Login failed. Check credentials.', 'error');
                    }
                } finally {
                    loading.value = false;
                }
            };

            const handleRegister = async () => {
                loading.value = true;
                connectionError.value = false;
                try {
                    const data = await apiCall('/user/register', 'POST', registerForm, false);

                    auth.user = data.user;
                    auth.token = data.accessToken;
                    safeStorage.setItem('auth_token', data.accessToken);

                    auth.isLoggedIn = true;
                    showToast('Account created successfully!');
                    await refreshData();
                } catch (e) {
                    if (connectionError.value) {
                        showToast('Connection failed (CORS/Network)', 'error');
                    } else {
                        showToast('Registration failed.', 'error');
                    }
                } finally {
                    loading.value = false;
                }
            };

            const refreshData = async () => {
                try {
                    const [tasksData, statsData] = await Promise.all([
                        apiCall('/tasks'),
                        apiCall('/tasks/statistics')
                    ]);
                    tasks.value = Array.isArray(tasksData) ? tasksData : (tasksData.tasks || []);
                    Object.assign(stats, statsData);
                } catch (e) {
                    console.error(e);
                }
            };

            const logout = () => {
                auth.isLoggedIn = false;
                auth.user = null;
                auth.token = null;
                safeStorage.removeItem('auth_token');
                tasks.value = [];
                currentView.value = 'dashboard';
                // Optional: Call logout API to clear cookie
                // apiCall('/user/logout', 'POST');
            };

            const createTaskAI = async () => {
                if (!quickAiInput.value) return;
                loading.value = true;
                try {
                    const newTasks = await apiCall('/tasks/natural-language', 'POST', {
                        naturalLanguage: quickAiInput.value
                    });
                    tasks.value.push(...newTasks);
                    quickAiInput.value = '';
                    showToast('Task created via AI!');
                    refreshData();
                } catch (e) {
                    showToast('Failed to create task', 'error');
                } finally {
                    loading.value = false;
                }
            };

            const processNaturalLanguage = async () => {
                if (!naturalLanguageInput.value) return;
                loading.value = true;
                try {
                    const newTasks = await apiCall('/tasks/natural-language', 'POST', {
                        naturalLanguage: naturalLanguageInput.value
                    });
                    tasks.value.push(...newTasks);
                    naturalLanguageInput.value = '';
                    showToast(`${newTasks.length} tasks created!`);
                    currentView.value = 'tasks';
                } catch (e) {
                    showToast('AI Parsing failed', 'error');
                } finally {
                    loading.value = false;
                }
            };

            const getPriorityRecommendations = async () => {
                loading.value = true;
                try {
                    const recs = await apiCall('/task-priority/recommendations', 'POST', {
                        taskIds: tasks.value.map(t => t.id),
                        recalculate: true
                    });
                    recommendations.value = recs;
                } catch (e) {
                    showToast('Could not fetch recommendations', 'error');
                } finally {
                    loading.value = false;
                }
            };

            const createTaskManual = async () => {
                try {
                    const res = await apiCall('/tasks', 'POST', newTask);
                    tasks.value.push(res);
                    showCreateModal.value = false;
                    showToast('Task created');
                    newTask.title = '';
                    newTask.description = '';
                } catch (e) {
                    showToast('Error creating task', 'error');
                }
            };

            const deleteTask = async (id) => {
                if (!confirm("Delete this task?")) return;
                try {
                    await apiCall(`/tasks/${id}`, 'DELETE');
                    tasks.value = tasks.value.filter(t => t.id !== id);
                    showToast('Task deleted');
                } catch (e) {
                    showToast('Delete failed', 'error');
                }
            };

            // --- UI Helpers ---
            const navClass = (view) => {
                return currentView.value === view
                    ? 'bg-indigo-50 text-indigo-700'
                    : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900';
            };

            const statusColor = (status) => {
                switch (status) {
                    case 'TODO':
                        return 'bg-slate-300';
                    case 'IN_PROGRESS':
                        return 'bg-blue-500';
                    case 'COMPLETED':
                        return 'bg-green-500';
                    case 'OVERDUE':
                        return 'bg-red-500';
                    default:
                        return 'bg-slate-300';
                }
            };

            const statusBadgeClass = (status) => {
                switch (status) {
                    case 'TODO':
                        return 'bg-slate-100 text-slate-600';
                    case 'IN_PROGRESS':
                        return 'bg-blue-100 text-blue-700';
                    case 'COMPLETED':
                        return 'bg-green-100 text-green-700';
                    default:
                        return 'bg-slate-100 text-slate-600';
                }
            };

            const isOverdue = (dateStr) => {
                if (!dateStr) return false;
                return new Date(dateStr) < new Date();
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return d.toLocaleDateString() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
            };

            return {
                isDemoMode,
                connectionError,
                loading,
                auth,
                isRegistering,
                loginForm,
                registerForm,
                handleLogin,
                handleRegister,
                logout,
                currentView,
                tasks,
                stats,
                navClass,
                userInitials,
                todayDate: new Date().toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'}),
                quickAiInput,
                createTaskAI,
                filteredTasks,
                priorityTasks,
                filters,
                statusColor,
                statusBadgeClass,
                isOverdue,
                formatDate,
                naturalLanguageInput,
                processNaturalLanguage,
                recommendations,
                getPriorityRecommendations,
                showCreateModal,
                newTask,
                createTaskManual,
                deleteTask,
                editTask: (t) => {
                    alert("Task details: " + t.title)
                },
                toast,
                // Calendar exports
                calendarMode,
                currentCalendarDate,
                calendarTitle,
                calendarDays,
                weekDays,
                changeCalendarPeriod,
                resetCalendarToToday,
                getTasksForDate,
                taskStyle,
                formatTime,
                openCreateModal,
                formatDateInput
            };
        }
    }).mount('#app');
</script>
</body>
</html>